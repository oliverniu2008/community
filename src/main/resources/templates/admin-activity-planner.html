<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Activity Planner AI Agent - Admin</title>
  <link rel="stylesheet" href="/css/styles.css"/>
</head>
<body class="admin-theme">
<div class="admin-container">
  <header class="admin-header">
    <h1>ğŸ¯ Activity Planner AI Agent</h1>
    <nav class="admin-nav">
      <a href="/admin/users" class="nav-tab">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-text">Users</span>
      </a>
      <a href="/admin/communities" class="nav-tab">
        <span class="nav-icon">ğŸ˜ï¸</span>
        <span class="nav-text">Communities</span>
      </a>
      <a href="/admin/leaders" class="nav-tab">
        <span class="nav-icon">â­</span>
        <span class="nav-text">Leaders & Rewards</span>
      </a>
      <a href="/admin/moderation" class="nav-tab">
        <span class="nav-icon">ğŸ›¡ï¸</span>
        <span class="nav-text">Moderation</span>
      </a>
      <a href="/admin/analytics" class="nav-tab">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-text">Analytics</span>
      </a>
      <a href="/admin/content-generator" class="nav-tab">
        <span class="nav-icon">ğŸ¤–</span>
        <span class="nav-text">Content Generator</span>
      </a>
      <a href="/admin/activity-planner" class="nav-tab active">
        <span class="nav-icon">ğŸ¯</span>
        <span class="nav-text">Activity Planner</span>
      </a>
    </nav>
  </header>

  <section class="activity-planner-console">
    <div class="console-header">
      <h2>ğŸ¤– Multi-Step Activity Planner AI Agent</h2>
      <p>Powered by GPT-4o with LangChain | Real-time web search & intelligent planning</p>
    </div>
    
    <!-- Service Status -->
    <div class="service-status-card">
      <div class="status-header">
        <h3>ğŸ“Š Service Status</h3>
        <button type="button" class="btn btn-secondary" onclick="refreshStatus()">
          <span class="btn-icon">ğŸ”„</span>
          Refresh
        </button>
      </div>
      
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">OpenAI API</div>
          <div class="status-value" th:classappend="${serviceStatus.openaiConfigured} ? 'status-success' : 'status-error'">
            <span th:if="${serviceStatus.openaiConfigured}">âœ… Configured</span>
            <span th:unless="${serviceStatus.openaiConfigured}">âŒ Not Configured</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Tavily API</div>
          <div class="status-value" th:classappend="${serviceStatus.tavilyConfigured} ? 'status-success' : 'status-error'">
            <span th:if="${serviceStatus.tavilyConfigured}">âœ… Configured</span>
            <span th:unless="${serviceStatus.tavilyConfigured}">âŒ Not Configured</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Streamlit Service</div>
          <div class="status-value" th:classappend="${serviceStatus.streamlitRunning} ? 'status-success' : 'status-warning'">
            <span th:if="${serviceStatus.streamlitRunning}">ğŸŸ¢ Running</span>
            <span th:unless="${serviceStatus.streamlitRunning}">ğŸŸ¡ Stopped</span>
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Service URL</div>
          <div class="status-value status-info">
            <a th:href="${serviceStatus.serviceUrl}" th:text="${serviceStatus.serviceUrl}" target="_blank">Service URL</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Service Controls -->
    <div class="service-controls">
      <h3>ğŸ® Service Controls</h3>
      <div class="control-buttons">
        <button type="button" class="btn btn-primary btn-large" onclick="startService()">
          <span class="btn-icon">ğŸš€</span>
          Start Activity Planner Service
        </button>
        <button type="button" class="btn btn-secondary btn-large" onclick="stopService()">
          <span class="btn-icon">â¹ï¸</span>
          Stop Service
        </button>
        <button type="button" class="btn btn-outline btn-large" onclick="openService()" th:disabled="${!serviceStatus.streamlitRunning}">
          <span class="btn-icon">ğŸŒ</span>
          Open Streamlit App
        </button>
      </div>
    </div>

    <!-- Service Documentation -->
    <div class="documentation-card">
      <h3>ğŸ“š Service Documentation</h3>
      
      <div class="doc-section">
        <h4>ğŸ¤– AI Agent Details</h4>
        <div class="doc-content">
          <p><strong>Name:</strong> <span th:text="${documentation.name}">Service Name</span></p>
          <p><strong>Description:</strong> <span th:text="${documentation.description}">Service Description</span></p>
          <p><strong>Model:</strong> <span th:text="${documentation.model}">GPT-4o</span></p>
        </div>
      </div>
      
      <div class="doc-section">
        <h4>ğŸ› ï¸ Available Tools</h4>
        <div class="tools-grid">
          <div class="tool-card" th:each="tool : ${documentation.tools}">
            <div class="tool-icon">ğŸ”§</div>
            <div class="tool-name" th:text="${tool}">Tool Name</div>
          </div>
        </div>
      </div>
      
      <div class="doc-section">
        <h4>âœ¨ Key Features</h4>
        <ul class="features-list">
          <li th:each="feature : ${documentation.features}" th:text="${feature}">Feature</li>
        </ul>
      </div>
      
      <div class="doc-section">
        <h4>âš™ï¸ Setup Requirements</h4>
        <div class="setup-info">
          <div class="setup-item">
            <strong>OpenAI API Key:</strong> <span th:text="${documentation.setup.openaiKey}">Setup instruction</span>
          </div>
          <div class="setup-item">
            <strong>Tavily API Key:</strong> <span th:text="${documentation.setup.tavilyKey}">Setup instruction</span>
          </div>
          <div class="setup-item">
            <strong>Dependencies:</strong>
            <ul>
              <li th:each="dep : ${documentation.setup.dependencies}" th:text="${dep}">Dependency</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Multi-Step Process Explanation -->
    <div class="process-explanation">
      <h3>ğŸ”„ Multi-Step Process Flow</h3>
      <div class="process-steps">
        <div class="step-item">
          <div class="step-number">1</div>
          <div class="step-content">
            <h4>Planning Validation</h4>
            <p>PlanningTool validates the request and confirms readiness for activity search</p>
          </div>
        </div>
        <div class="step-arrow">â†’</div>
        <div class="step-item">
          <div class="step-number">2</div>
          <div class="step-content">
            <h4>Real-time Search</h4>
            <p>TavilySearchTool searches for specific local activities in the specified location</p>
          </div>
        </div>
        <div class="step-arrow">â†’</div>
        <div class="step-item">
          <div class="step-number">3</div>
          <div class="step-content">
            <h4>Comprehensive Response</h4>
            <p>AI combines planning insights with search results for personalized recommendations</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Create New Planning Session -->
    <div class="create-session-section">
      <div class="session-header">
        <h3>ğŸ¯ Create New Planning Session</h3>
        <button type="button" class="btn btn-secondary" onclick="loadExampleQueries()">
          <span class="btn-icon">ğŸ’¡</span>
          Load Examples
        </button>
      </div>
      
      <div class="session-form">
        <div class="form-row">
          <div class="form-group">
            <label for="query-input">Activity Query</label>
            <input type="text" id="query-input" placeholder="e.g., Find indoor activities for my 3-year-old in Singapore" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="child-age">Child Age</label>
            <select id="child-age">
              <option value="">Select age</option>
              <option value="1">1 year old</option>
              <option value="2">2 years old</option>
              <option value="3">3 years old</option>
              <option value="4">4 years old</option>
              <option value="5">5 years old</option>
              <option value="6">6 years old</option>
              <option value="7">7 years old</option>
              <option value="8">8 years old</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" placeholder="e.g., Singapore, Tokyo, London" />
          </div>
          
          <div class="form-group">
            <label for="activity-type">Activity Type</label>
            <select id="activity-type">
              <option value="">Select type</option>
              <option value="indoor">Indoor</option>
              <option value="outdoor">Outdoor</option>
              <option value="educational">Educational</option>
              <option value="creative">Creative</option>
              <option value="sports">Sports</option>
              <option value="music">Music</option>
              <option value="general">General</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-primary" onclick="createPlanningSession()">
            <span class="btn-icon">ğŸš€</span>
            Create Planning Session
          </button>
        </div>
      </div>
      
      <div id="example-queries" class="example-queries-section" style="display: none;">
        <h4>ğŸ’¡ Example Queries</h4>
        <div id="example-queries-list" class="example-queries-list"></div>
      </div>
    </div>

    <!-- Activity Results Display -->
    <div class="results-display-section">
      <div class="results-header">
        <h3>ğŸ“Š Recent Activity Planning Results</h3>
        <button type="button" class="btn btn-secondary" onclick="refreshResults()">
          <span class="btn-icon">ğŸ”„</span>
          Refresh Results
        </button>
      </div>
      
      <div id="results-container" class="results-container">
        <div class="loading-indicator">
          <span class="loading-icon">â³</span>
          Loading recent results...
        </div>
      </div>
    </div>

    <!-- Example Queries -->
    <div class="examples-card">
      <h3>ğŸ’¡ Example Queries</h3>
      <div class="examples-grid">
        <div class="example-item">
          <div class="example-query">"Find indoor activities for my 3-year-old in Singapore"</div>
          <div class="example-description">Multi-step planning with local search</div>
        </div>
        <div class="example-item">
          <div class="example-query">"What are educational activities for a 5-year-old in Tokyo?"</div>
          <div class="example-description">Age-appropriate educational focus</div>
        </div>
        <div class="example-item">
          <div class="example-query">"Looking for outdoor activities for toddlers in London"</div>
          <div class="example-description">Weather and location considerations</div>
        </div>
        <div class="example-item">
          <div class="example-query">"Suggest age-appropriate activities for my 4-year-old in New York"</div>
          <div class="example-description">Comprehensive age and location analysis</div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
// Service control functions
async function startService() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Starting...';
  
  try {
    const response = await fetch('/admin/activity-planner/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification('âœ… Service started successfully!', 'success');
      setTimeout(() => location.reload(), 2000);
    } else {
      showNotification('âŒ Failed to start service: ' + result.error, 'error');
    }
  } catch (error) {
    showNotification('âŒ Error: ' + error.message, 'error');
  } finally {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">ğŸš€</span> Start Activity Planner Service';
  }
}

async function stopService() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Stopping...';
  
  try {
    const response = await fetch('/admin/activity-planner/stop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification('âœ… Service stopped successfully!', 'success');
      setTimeout(() => location.reload(), 2000);
    } else {
      showNotification('âŒ Failed to stop service: ' + result.error, 'error');
    }
  } catch (error) {
    showNotification('âŒ Error: ' + error.message, 'error');
  } finally {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">â¹ï¸</span> Stop Service';
  }
}

async function refreshStatus() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Refreshing...';
  
  try {
    const response = await fetch('/admin/activity-planner/status');
    const status = await response.json();
    
    showNotification('âœ… Status refreshed!', 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    showNotification('âŒ Error refreshing status: ' + error.message, 'error');
  } finally {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">ğŸ”„</span> Refresh';
  }
}

function openService() {
  const serviceUrl = document.querySelector('.status-info a').href;
  window.open(serviceUrl, '_blank');
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// Results display functions
async function loadRecentResults() {
  try {
    const response = await fetch('/admin/activity-planner/results');
    const data = await response.json();
    displayResults(data);
  } catch (error) {
    console.error('Error loading results:', error);
    showResultsError('Failed to load recent results');
  }
}

function displayResults(data) {
  const container = document.getElementById('results-container');
  
  if (!data.recentPlans || data.recentPlans.length === 0) {
    container.innerHTML = `
      <div class="no-results">
        <span class="no-results-icon">ğŸ“­</span>
        <p>No recent activity planning results found.</p>
        <p>Start a new planning session to see results here.</p>
      </div>
    `;
    return;
  }
  
  const resultsHtml = data.recentPlans.map(plan => `
    <div class="result-card" data-plan-id="${plan.id}">
      <div class="result-header">
        <div class="result-info">
          <h4 class="result-query">${plan.query}</h4>
          <div class="result-meta">
            <span class="result-age">ğŸ‘¶ Age: ${plan.childAge}</span>
            <span class="result-location">ğŸ“ ${plan.location}</span>
            <span class="result-type">ğŸ¯ ${plan.activityType}</span>
          </div>
        </div>
        <div class="result-status">
          <span class="status-badge status-${plan.status}">${plan.status}</span>
          <span class="result-count">${plan.resultsCount} results</span>
        </div>
      </div>
      
      <div class="result-summary">
        <p>${plan.summary}</p>
      </div>
      
      <div class="result-footer">
        <span class="result-timestamp">ğŸ•’ ${plan.timestamp}</span>
        <button class="btn btn-outline btn-sm" onclick="viewDetailedResults('${plan.id}')">
          <span class="btn-icon">ğŸ‘ï¸</span>
          View Details
        </button>
      </div>
    </div>
  `).join('');
  
  container.innerHTML = `
    <div class="results-grid">
      ${resultsHtml}
    </div>
    <div class="results-footer">
      <p class="results-summary">
        ğŸ“Š Showing ${data.recentPlans.length} recent planning sessions | 
        Last updated: ${data.lastUpdated}
      </p>
    </div>
  `;
}

async function viewDetailedResults(planId) {
  try {
    const response = await fetch(`/admin/activity-planner/results/${planId}`);
    const data = await response.json();
    showDetailedResultsModal(data);
  } catch (error) {
    console.error('Error loading detailed results:', error);
    showNotification('âŒ Failed to load detailed results', 'error');
  }
}

function showDetailedResultsModal(data) {
  if (!data.activities) {
    showNotification('âŒ No detailed results available', 'error');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>ğŸ¯ Activity Planning Results</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="plan-info">
          <h4>${data.query}</h4>
          <div class="plan-meta">
            <span class="plan-age">ğŸ‘¶ Age: ${data.childAge}</span>
            <span class="plan-location">ğŸ“ ${data.location}</span>
            <span class="plan-type">ğŸ¯ ${data.activityType}</span>
            <span class="plan-timestamp">ğŸ•’ ${data.timestamp}</span>
          </div>
        </div>
        
        <div class="plan-summary">
          <p><strong>Summary:</strong> ${data.summary}</p>
        </div>
        
        <div class="activities-section">
          <h4>ğŸª Recommended Activities</h4>
          <div class="activities-grid">
            ${data.activities.map(activity => `
              <div class="activity-card">
                <div class="activity-header">
                  <h5>${activity.name}</h5>
                  <div class="activity-type">${activity.type}</div>
                </div>
                
                <div class="activity-details">
                  <p class="activity-description">${activity.description}</p>
                  
                  <div class="activity-meta">
                    <div class="meta-item">
                      <span class="meta-label">ğŸ‘¶ Age Range:</span>
                      <span class="meta-value">${activity.ageRange}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">ğŸ“ Location:</span>
                      <span class="meta-value">${activity.location}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">ğŸ’° Price:</span>
                      <span class="meta-value">${activity.price}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">â±ï¸ Duration:</span>
                      <span class="meta-value">${activity.duration}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">â­ Rating:</span>
                      <span class="meta-value">${activity.rating}</span>
                    </div>
                  </div>
                  
                  <div class="activity-highlights">
                    <div class="highlight-item">
                      <span class="highlight-label">ğŸ›¡ï¸ Safety:</span>
                      <span class="highlight-value">${activity.safety}</span>
                    </div>
                    <div class="highlight-item">
                      <span class="highlight-label">ğŸ“ Educational Value:</span>
                      <span class="highlight-value">${activity.educationalValue}</span>
                    </div>
                  </div>
                  
                  <div class="activity-actions">
                    <a href="${activity.url}" target="_blank" class="btn btn-primary btn-sm">
                      <span class="btn-icon">ğŸŒ</span>
                      Visit Website
                    </a>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        ${data.recommendations ? `
          <div class="recommendations-section">
            <h4>ğŸ’¡ AI Recommendations</h4>
            <ul class="recommendations-list">
              ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close modal when clicking outside
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });
}

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) {
    modal.remove();
  }
}

function refreshResults() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Refreshing...';
  
  loadRecentResults().finally(() => {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">ğŸ”„</span> Refresh Results';
  });
}

function showResultsError(message) {
  const container = document.getElementById('results-container');
  container.innerHTML = `
    <div class="results-error">
      <span class="error-icon">âŒ</span>
      <p>${message}</p>
      <button class="btn btn-secondary btn-sm" onclick="loadRecentResults()">
        <span class="btn-icon">ğŸ”„</span>
        Try Again
      </button>
    </div>
  `;
}

// Auto-refresh status every 30 seconds
setInterval(() => {
  fetch('/admin/activity-planner/status')
    .then(response => response.json())
    .then(status => {
      // Update status indicators without full page reload
      console.log('Status updated:', status);
    })
    .catch(error => console.error('Status check failed:', error));
}, 30000);

// Create new planning session functions
async function createPlanningSession() {
  const query = document.getElementById('query-input').value.trim();
  const childAge = document.getElementById('child-age').value;
  const location = document.getElementById('location').value.trim();
  const activityType = document.getElementById('activity-type').value;
  
  if (!query || !childAge || !location || !activityType) {
    showNotification('âŒ Please fill in all fields', 'error');
    return;
  }
  
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Creating...';
  
  try {
    const response = await fetch('/admin/activity-planner/create-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `query=${encodeURIComponent(query)}&childAge=${encodeURIComponent(childAge)}&location=${encodeURIComponent(location)}&activityType=${encodeURIComponent(activityType)}`
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification('âœ… New planning session created successfully!', 'success');
      // Clear form
      document.getElementById('query-input').value = '';
      document.getElementById('child-age').value = '';
      document.getElementById('location').value = '';
      document.getElementById('activity-type').value = '';
      // Refresh results to show the new session
      loadRecentResults();
    } else {
      showNotification('âŒ Failed to create planning session: ' + result.error, 'error');
    }
  } catch (error) {
    showNotification('âŒ Error: ' + error.message, 'error');
  } finally {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">ğŸš€</span> Create Planning Session';
  }
}

async function loadExampleQueries() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.innerHTML = '<span class="btn-icon">â³</span> Loading...';
  
  try {
    const response = await fetch('/admin/activity-planner/example-queries');
    const examples = await response.json();
    
    const examplesContainer = document.getElementById('example-queries');
    const examplesList = document.getElementById('example-queries-list');
    
    const examplesHtml = examples.map(example => `
      <div class="example-query-item" onclick="useExampleQuery('${example.query}', '${example.childAge}', '${example.location}', '${example.activityType}')">
        <div class="example-query-text">${example.query}</div>
        <div class="example-query-meta">
          <span class="example-age">ğŸ‘¶ ${example.childAge} years</span>
          <span class="example-location">ğŸ“ ${example.location}</span>
          <span class="example-type">ğŸ¯ ${example.activityType}</span>
        </div>
      </div>
    `).join('');
    
    examplesList.innerHTML = examplesHtml;
    examplesContainer.style.display = 'block';
    
    showNotification('âœ… Example queries loaded!', 'success');
  } catch (error) {
    showNotification('âŒ Error loading examples: ' + error.message, 'error');
  } finally {
    button.disabled = false;
    button.innerHTML = '<span class="btn-icon">ğŸ’¡</span> Load Examples';
  }
}

function useExampleQuery(query, childAge, location, activityType) {
  document.getElementById('query-input').value = query;
  document.getElementById('child-age').value = childAge;
  document.getElementById('location').value = location;
  document.getElementById('activity-type').value = activityType;
  
  // Hide examples section
  document.getElementById('example-queries').style.display = 'none';
  
  showNotification('âœ… Example query loaded into form!', 'success');
}

// Load results on page load
document.addEventListener('DOMContentLoaded', () => {
  loadRecentResults();
});
</script>
</body>
</html>
